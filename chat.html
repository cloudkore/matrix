<!DOCTYPE html>
<html lang="en">
<head>
  <title>Global Chat - NinjaBase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="css/bootstrap.css" rel="stylesheet" media="screen">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="js/sound.js"></script>
  <script src="js/essentials.js"></script>
  <style>
    body {
      background: black;
      color: white;
    }
    .chat-box {
      max-width: 700px;
      margin: 50px auto;
      background: #111;
      padding: 20px;
      border-radius: 10px;
    }
    .message {
      margin-bottom: 10px;
    }
    .message-user {
      font-weight: bold;
    }
    .timestamp {
      color: #888;
      font-size: 0.8em;
      margin-left: 5px;
    }
    #messages {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #333;
      padding: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>

  <div class="container chat-box">
    <h2>Global Chat</h2>
    <div id="messages"></div>
    <textarea id="msgInput" class="form-control" placeholder="Type your message..."></textarea>
    <button id="sendBtn" class="btn btn-primary mt-2">Send</button>
    <button id="logoutBtn" class="btn btn-danger mt-2">Logout</button>
  </div>

  <div id="footer-placeholder"></div>

  <script src="js/bootstrap.min.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCwEZaP_Oc7MRwfxIXyq0k7sH4LQBEc3YY",
      authDomain: "matrix-nso.firebaseapp.com",
      projectId: "matrix-nso",
      storageBucket: "matrix-nso.firebasestorage.app",
      messagingSenderId: "32108162722",
      appId: "1:32108162722:web:7c80d154d4120111c271fb"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("You must be logged in to chat.");
        window.location.href = "core.html";
        return;
      }

      db.collection("global_chat")
        .orderBy("timestamp", "asc")
        .onSnapshot(snapshot => {
          messagesDiv.innerHTML = "";
          snapshot.forEach(doc => {
            const msg = doc.data();
            const time = msg.timestamp?.toDate().toLocaleTimeString() || "??:??";
            const div = document.createElement("div");
            div.className = "message";
            div.innerHTML = `<span class="message-user">${msg.user}</span>: ${msg.text} <span class="timestamp">[${time}]</span>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          });
        });

      sendBtn.onclick = () => {
        const text = msgInput.value.trim();
        if (!text) return;
        db.collection("global_chat").add({
          user: user.email,
          text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        msgInput.value = "";
      };

      logoutBtn.onclick = () => auth.signOut();
    });
  </script>
</body>
</html>